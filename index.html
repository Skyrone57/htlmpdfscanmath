<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Estimation Tool - Google Maps Satellite Image Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9ff;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background-color: #f0f2ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background-color: #e8ebff;
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #666;
            margin: 10px 0;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .image-preview {
            position: relative;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        
        .image-preview img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .image-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        canvas {
            max-width: 100%;
            height: auto;
            display: block;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .measurement-info {
            background-color: #e8ebff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .measurement-info.show {
            display: block;
        }
        
        .measurement-info p {
            color: #333;
            margin: 5px 0;
            font-size: 0.95em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-group {
            display: grid;
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 10px;
            accent-color: #667eea;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-danger {
            background-color: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #ee5a52;
        }
        
        .estimate-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }
        
        .estimate-container.show {
            display: block;
        }
        
        .estimate-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }
        
        .estimate-header h1 {
            color: #333;
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .estimate-header p {
            color: #666;
            font-size: 0.95em;
        }
        
        .estimate-section {
            margin-bottom: 30px;
        }
        
        .estimate-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
            padding-left: 10px;
            border-left: 4px solid #667eea;
        }
        
        .work-items {
            list-style: none;
            counter-reset: item;
        }
        
        .work-items li {
            counter-increment: item;
            margin-bottom: 12px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        .work-items li:before {
            content: counter(item) ". ";
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
        }
        
        .estimate-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
        }
        
        .estimate-total h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .total-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .notes {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        
        .notes p {
            color: #333;
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .measurement-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .measurement-controls button {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            font-size: 0.9em;
        }
        
        .hint-text {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .summary-box {
            background-color: #f0f2ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .summary-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .address-search-section {
            background-color: #f0f2ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .address-search-section h3 {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 12px;
            margin-top: 0;
        }

        .address-search-section input {
            padding: 12px;
            border: 2px solid #667eea;
        }

        .address-result {
            background-color: #e8ebff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #333;
        }

        .address-error {
            background-color: #ffebee;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #c62828;
            border-left: 4px solid #ff6b6b;
        }

        .coordinates-display {
            font-size: 0.85em;
            margin-top: 8px;
            color: #666;
            font-style: italic;
        }

        .address-suggestion-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .address-suggestion-item:hover {
            background-color: #f0f2ff;
        }

        .address-suggestion-item strong {
            display: block;
            color: #333;
            margin-bottom: 3px;
        }

        .address-suggestion-item small {
            color: #999;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè† Roof Estimation Tool</h1>
            <p>Analyze Google Maps satellite images to create detailed roof replacement estimates</p>
        </header>
        
        <div class="main-content">
            <!-- Left Panel: Address Input -->
            <div class="panel">
                <h2>üè† Property Address</h2>
                
                <div class="form-group">
                    <label for="addressInput">Enter Address</label>
                    <input type="text" id="addressInput" placeholder="e.g., 3519 Sciotangy Dr..." autocomplete="off">
                    <div id="addressSuggestions" style="border: 1px solid #ddd; border-top: none; display: none; max-height: 200px; overflow-y: auto; background: white; border-radius: 0 0 6px 6px;"></div>
                    <button class="upload-btn" onclick="searchAddress()" style="width: 100%; margin-top: 10px;">
                        üîç Search Address
                    </button>
                </div>
                
                <div id="addressResult"></div>
                
                <div class="image-preview" id="imagePreview">
                    <div class="image-container">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Estimation Form -->
            <div class="panel">
                <h2>üìã Estimation Details</h2>
                
                <div class="form-group">
                    <label for="roofArea">Estimated Roof Area (Square Feet)</label>
                    <input type="number" id="roofArea" placeholder="e.g., 4700" min="0" step="10">
                    <p class="hint-text">Default estimate based on property. Adjust if needed.</p>
                </div>
                
                <div class="input-group">
                    <div class="form-group">
                        <label for="roofSlope">Roof Slope</label>
                        <select id="roofSlope">
                            <option value="4/12">4/12 (Moderate)</option>
                            <option value="6/12">6/12 (Standard)</option>
                            <option value="8/12">8/12 (Steep)</option>
                            <option value="12/12">12/12 (Very Steep)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shingleType">Shingle Type</label>
                        <select id="shingleType">
                            <option value="atlas">Atlas Pinnacle Pristine</option>
                            <option value="gaf">GAF Timberline</option>
                            <option value="certainteed">CertainTeed Presidential</option>
                            <option value="iko">IKO Cambridge</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Additional Work Items</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="gutters" checked>
                            <label for="gutters">Full Gutter Replacement</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="decking" checked>
                            <label for="decking">Wood Decking Inspection & Repair</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="flashing">
                            <label for="flashing">Replace All Flashing</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ventilation">
                            <label for="ventilation">Add Ridge Vent</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="laborCostPerSF">Estimated Labor Cost per SF*</label>
                    <input type="number" id="laborCostPerSF" value="4.50" min="0" step="0.10">
                </div>
                
                <div class="form-group">
                    <label for="estimatorName">Estimator Name (Optional)</label>
                    <input type="text" id="estimatorName" placeholder="e.g., Dave Crego">
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="generateEstimate()">
                        ‚úì Generate Estimate
                    </button>
                    <button class="btn-secondary" onclick="resetForm()">
                        ‚Üª Reset Form
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Estimate Output -->
        <div class="estimate-container" id="estimateContainer">
            <div class="estimate-header">
                <h1>ROOF REPLACEMENT ESTIMATE</h1>
                <p id="propertyAddress" style="color: #666; font-size: 0.95em; margin: 10px 0;"></p>
                <p id="estimateDate"></p>
            </div>
            
            <div class="estimate-section">
                <h3>Work Scope</h3>
                <ul class="work-items" id="workItems"></ul>
            </div>
            
            <div class="estimate-total">
                <h2>ESTIMATE TOTAL</h2>
                <div class="total-amount" id="totalAmount">$22,000</div>
            </div>
            
            <div class="estimate-section" id="additionalSection" style="display: none;">
                <h3>Additional Services</h3>
                <p id="additionalText"></p>
                <div class="estimate-total" style="background: white; color: #667eea; border: 2px solid #667eea; margin: 20px 0;">
                    <h3>WITH ADDITIONAL SERVICES</h3>
                    <div id="totalWithAddl" style="font-size: 2em; font-weight: bold;">$23,500</div>
                </div>
            </div>
            
            <div class="notes">
                <h4>üìù Important Notes</h4>
                <p id="notesText"></p>
            </div>
            
            <div class="summary-box">
                <h4>Estimate Summary</h4>
                <div class="summary-item">
                    <span>Roof Area:</span>
                    <strong id="summaryArea">4700 SF</strong>
                </div>
                <div class="summary-item">
                    <span>Material Type:</span>
                    <strong id="summaryMaterial">Atlas Pinnacle</strong>
                </div>
                <div class="summary-item">
                    <span>Labor Cost/SF:</span>
                    <strong id="summaryLabor">$4.50</strong>
                </div>
                <div class="summary-item">
                    <span>Estimated by:</span>
                    <strong id="summaryEstimator">Professional Estimator</strong>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn-primary" onclick="exportToPDF()">
                    üì• Download as PDF
                </button>
                <button class="btn-secondary" onclick="printEstimate()">
                    üñ®Ô∏è Print Estimate
                </button>
                <button class="btn-secondary" onclick="resetAll()">
                    ‚Üª Start Over
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        let canvas, ctx;
        let imageLoaded = false;
        let measurementMode = false;
        let points = [];
        let pixelsPerFoot = null;
        let currentImage = null;
        let geocoder = null;
        let currentAddress = 'Unknown Address';
        let searchInProgress = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            setupEventListeners();
            
            // Initialize geocoder after Google Maps API loads - with retry logic
            let retries = 0;
            const initializeGeocoder = () => {
                if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                    geocoder = new google.maps.Geocoder();
                    console.log('‚úì Google Maps Geocoder initialized successfully');
                } else {
                    retries++;
                    if (retries < 20) { // Try for up to 20 seconds
                        console.log('Waiting for Google Maps API... (attempt ' + retries + ')');
                        setTimeout(initializeGeocoder, 1000);
                    } else {
                        console.error('Failed to load Google Maps API after multiple attempts');
                    }
                }
            };
            initializeGeocoder();
        });
    </script>
    
    <!-- Load Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrJ-HvLTrpyVOVsZW3ooNALyDhXe4lBh8&libraries=places"></script>
    
    <script>
        
        function getProxyURL(endpoint, params) {
            // Use relative URLs - same origin, so no CORS issues
            let url = endpoint;
            if (params) {
                const queryString = Object.keys(params)
                    .map(key => `${key}=${encodeURIComponent(params[key])}`)
                    .join('&');
                url += `?${queryString}`;
            }
            return url;
        }
        
        function setupEventListeners() {
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                imageInput.addEventListener('change', (e) => {
                    handleImageSelect(e.target.files[0]);
                });
            }
            
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousemove', handleCanvasHover);
            
            // Add address autocomplete
            const addressInput = document.getElementById('addressInput');
            addressInput.addEventListener('input', (e) => {
                const value = e.target.value.trim();
                if (value.length > 2) {
                    getAddressSuggestions(value);
                } else {
                    document.getElementById('addressSuggestions').style.display = 'none';
                }
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'addressInput' && !e.target.classList.contains('address-suggestion-item')) {
                    document.getElementById('addressSuggestions').style.display = 'none';
                }
            });
        }
        
        function getAddressSuggestions(query) {
            console.log('Getting suggestions for:', query);
            
            const proxyUrl = getProxyURL('/api/geocode', { q: query, limit: 5 });
            console.log('Proxy URL:', proxyUrl);
            
            fetch(proxyUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('Suggestions:', data);
                    
                    const suggestionsDiv = document.getElementById('addressSuggestions');
                    suggestionsDiv.innerHTML = '';
                    
                    if (data && data.length > 0) {
                        data.forEach((result, index) => {
                            const item = document.createElement('div');
                            item.className = 'address-suggestion-item';
                            
                            // Get the main address line
                            const addressLine = result.display_name.split(',')[0];
                            const fullAddress = result.display_name;
                            
                            item.innerHTML = `
                                <strong>${addressLine}</strong>
                                <small>${fullAddress.substring(addressLine.length + 2)}</small>
                            `;
                            
                            item.onclick = () => {
                                console.log('Selected address:', fullAddress);
                                document.getElementById('addressInput').value = addressLine;
                                selectAddressSuggestion(result.lat, result.lon, fullAddress);
                                suggestionsDiv.style.display = 'none';
                            };
                            
                            suggestionsDiv.appendChild(item);
                        });
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error getting suggestions:', error);
                });
        }
        
        function selectAddressSuggestion(lat, lng, fullAddress) {
            console.log('Selected:', lat, lng, fullAddress);
            
            // Convert to numbers in case they come as strings from API
            lat = parseFloat(lat);
            lng = parseFloat(lng);
            
            currentAddress = fullAddress;
            searchInProgress = true;
            
            showAddressResult(fullAddress, lat, lng);
            
            // Fetch satellite image
            fetchSatelliteImageOSM(lat, lng, fullAddress);
            
            // Analyze roof area from satellite image
            console.log('Analyzing roof from satellite image...');
            fetch(getProxyURL('/api/analyze-roof', { lat: lat, lng: lng }))
                .then(response => response.json())
                .then(data => {
                    if (data.roof_area) {
                        console.log('‚úì Auto-detected roof area:', data.roof_area, 'SF');
                        document.getElementById('roofArea').value = data.roof_area;
                    }
                })
                .catch(error => {
                    console.log('Could not auto-detect roof area, using default:', error);
                    document.getElementById('roofArea').value = '4500';
                });
        }
        
        function searchAddress() {
            const address = document.getElementById('addressInput').value.trim();
            
            if (!address) {
                showAddressError('Please enter an address');
                return;
            }
            
            if (searchInProgress) {
                alert('Search already in progress. Please wait...');
                return;
            }
            
            searchInProgress = true;
            console.log('=== Address Search Started ===');
            console.log('Address input:', address);
            
            // Show loading state
            showAddressResult('üîÑ Searching...', 0, 0);
            
            // Use local proxy server
            console.log('Using local proxy server...');
            
            const proxyUrl = getProxyURL('/api/geocode', { q: address, limit: 1 });
            console.log('Fetching from:', proxyUrl);
            
            fetch(proxyUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('=== Nominatim Response ===');
                    console.log('Raw data:', data);
                    
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);
                        const displayName = result.display_name;
                        
                        console.log('‚úì Location found!');
                        console.log('Lat:', lat, 'Lng:', lng);
                        console.log('Display name:', displayName);
                        
                        // Update input with full address from Nominatim
                        document.getElementById('addressInput').value = displayName.split(',')[0];
                        
                        currentAddress = displayName;
                        showAddressResult(displayName, lat, lng);
                        
                        // Fetch satellite image
                        fetchSatelliteImageOSM(lat, lng, displayName);
                        
                        // Analyze roof area from satellite image
                        console.log('Analyzing roof from satellite image...');
                        fetch(getProxyURL('/api/analyze-roof', { lat: lat, lng: lng }))
                            .then(response => response.json())
                            .then(data => {
                                if (data.roof_area) {
                                    console.log('‚úì Auto-detected roof area:', data.roof_area, 'SF');
                                    document.getElementById('roofArea').value = data.roof_area;
                                    // Trigger estimate generation after setting roof area
                                    setTimeout(() => generateEstimate(), 500);
                                }
                            })
                            .catch(error => {
                                console.log('Could not auto-detect roof area, using default:', error);
                                document.getElementById('roofArea').value = '4500';
                                setTimeout(() => generateEstimate(), 500);
                            });
                    } else {
                        console.error('No results from Nominatim');
                        showAddressError('Address not found. Start typing to see suggestions.');
                        searchInProgress = false;
                    }
                })
                .catch(error => {
                    console.error('Error fetching location:', error);
                    console.error('Error details:', error.message);
                    showAddressError('Error finding address: ' + error.message);
                    searchInProgress = false;
                });
        }
        
        function fetchSatelliteImage(lat, lng, address) {
            // Using Google Maps Static API for satellite imagery
            const zoom = 19;
            const mapType = 'satellite';
            const size = '800x600';
            const apiKey = 'AIzaSyDrJ-HvLTrpyVOVsZW3ooNALyDhXe4lBh8';
            
            const imageUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=${zoom}&size=${size}&maptype=${mapType}&key=${apiKey}`;
            
            console.log('Fetching satellite image from Google Maps...');
            
            const img = new Image();
            img.crossOrigin = "anonymous";
            
            img.onload = () => {
                console.log('‚úì Google satellite image loaded');
                currentImage = img;
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                imageLoaded = true;
                
                document.getElementById('imagePreview').style.display = 'block';
                points = [];
                pixelsPerFoot = null;
                measurementMode = false;
                
                // Auto-generate estimate
                setTimeout(() => {
                    generateEstimate();
                }, 300);
            };
            
            img.onerror = (error) => {
                console.error('Google Maps image failed, trying fallback...');
                // Fallback to open map
                fetchSatelliteImageOSM(lat, lng, address);
            };
            
            img.src = imageUrl;
        }
        
        function fetchSatelliteImageOSM(lat, lng, address) {
            // Using Bing Maps aerial imagery via OpenStreetMap tiles
            console.log('Fetching satellite image for:', address);
            console.log('Coordinates:', lat, lng);
            
            const zoom = 18;
            const x = Math.floor((lng + 180) / 360 * Math.pow(2, zoom));
            const y = Math.floor((1 - Math.log(Math.tan((lat * Math.PI) / 180) + 1 / Math.cos((lat * Math.PI) / 180)) / Math.PI) / 2 * Math.pow(2, zoom));
            
            const imageUrl = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
            
            console.log('Satellite image URL:', imageUrl);
            
            const img = new Image();
            img.crossOrigin = "anonymous";
            
            img.onload = () => {
                console.log('‚úì Satellite image loaded successfully');
                currentImage = img;
                canvas.width = 800;
                canvas.height = 600;
                
                // Draw the tile and scale it
                ctx.drawImage(img, 0, 0, 256, 256, 0, 0, 800, 600);
                imageLoaded = true;
                
                document.getElementById('imagePreview').style.display = 'block';
                points = [];
                pixelsPerFoot = null;
                measurementMode = false;
                
                currentAddress = address;
                document.getElementById('roofArea').value = '4500';
                
                // Auto-generate estimate
                console.log('Generating estimate...');
                setTimeout(() => {
                    searchInProgress = false;
                    generateEstimate();
                }, 300);
            };
            
            img.onerror = (error) => {
                console.error('Satellite image load failed, proceeding anyway...');
                document.getElementById('imagePreview').style.display = 'none';
                currentAddress = address;
                document.getElementById('roofArea').value = '4500';
                
                // Still generate estimate automatically
                setTimeout(() => {
                    searchInProgress = false;
                    generateEstimate();
                }, 300);
            };
            
            img.src = imageUrl;
        }
        
        function showAddressResult(address, lat, lng) {
            const resultDiv = document.getElementById('addressResult') || createAddressResultDiv();
            // Ensure lat and lng are numbers
            lat = parseFloat(lat);
            lng = parseFloat(lng);
            
            if (lat !== 0 && lng !== 0) {
                resultDiv.innerHTML = `
                    <p><strong>‚úì Location Found:</strong></p>
                    <p>${address}</p>
                    <div class="coordinates-display">
                        Coordinates: ${lat.toFixed(4)}, ${lng.toFixed(4)}
                    </div>
                `;
                resultDiv.className = 'address-result';
            } else {
                resultDiv.innerHTML = `<p>üîÑ ${address}</p>`;
                resultDiv.className = 'address-result';
            }
            console.log('Address result displayed:', address);
        }
        
        function showAddressError(message) {
            const resultDiv = document.getElementById('addressResult') || createAddressResultDiv();
            resultDiv.innerHTML = `<p><strong>‚ùå Error:</strong> ${message}</p>`;
            resultDiv.className = 'address-error';
            console.error('Address error:', message);
        }
        
        function createAddressResultDiv() {
            let resultDiv = document.getElementById('addressResult');
            if (!resultDiv) {
                resultDiv = document.createElement('div');
                resultDiv.id = 'addressResult';
                document.getElementById('addressInput').parentElement.appendChild(resultDiv);
            }
            return resultDiv;
        }
        
        function handleImageSelect(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    imageLoaded = true;
                    
                    document.getElementById('imagePreview').style.display = 'block';
                    points = [];
                    pixelsPerFoot = null;
                    measurementMode = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function toggleMeasurementMode() {
            // Placeholder - not used in simplified version
        }
        
        function handleCanvasClick(e) {
            if (!measurementMode || !imageLoaded) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            points.push({x, y});
            redrawCanvas();
            updateMeasurementInfo();
        }
        
        function handleCanvasHover(e) {
            if (!measurementMode || !imageLoaded) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            redrawCanvas();
            
            // Draw preview line from last point to cursor
            if (points.length > 0) {
                ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(points[points.length - 1].x, points[points.length - 1].y);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        }
        
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0);
            
            if (measurementMode && points.length > 0) {
                // Draw points
                points.forEach((p, idx) => {
                    ctx.fillStyle = '#667eea';
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw point number
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(idx + 1, p.x, p.y);
                });
                
                // Draw lines connecting points
                if (points.length > 1) {
                    for (let i = 0; i < points.length - 1; i++) {
                        ctx.strokeStyle = '#667eea';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(points[i].x, points[i].y);
                        ctx.lineTo(points[i + 1].x, points[i + 1].y);
                        ctx.stroke();
                    }
                    
                    // Close the polygon
                    if (points.length >= 3) {
                        ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(points[points.length - 1].x, points[points.length - 1].y);
                        ctx.lineTo(points[0].x, points[0].y);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }
            }
        }
        
        function updateMeasurementInfo() {
            const info = document.getElementById('measurementInfo');
            const pixelInfo = document.getElementById('pixelInfo');
            const areaInfo = document.getElementById('areaInfo');
            const pixelPerFeetInfo = document.getElementById('pixelPerFeetInfo');
            
            pixelInfo.textContent = `Points marked: ${points.length}`;
            
            if (points.length >= 3) {
                const area = calculatePolygonArea();
                areaInfo.textContent = `Area in pixels: ${Math.round(area)}`;
                
                if (pixelsPerFoot) {
                    const squareFeet = area / (pixelsPerFoot * pixelsPerFoot);
                    areaInfo.textContent += ` | Area in SF: ${Math.round(squareFeet)}`;
                    document.getElementById('roofArea').value = Math.round(squareFeet);
                } else {
                    areaInfo.textContent += ` | Set scale first`;
                }
            } else {
                areaInfo.textContent = '';
            }
            
            if (pixelsPerFoot) {
                pixelPerFeetInfo.textContent = `Scale: ${pixelsPerFoot.toFixed(2)} pixels/foot`;
            }
        }
        
        function calculatePolygonArea() {
            if (points.length < 3) return 0;
            
            let area = 0;
            for (let i = 0; i < points.length; i++) {
                const j = (i + 1) % points.length;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            return Math.abs(area) / 2;
        }
        
        function setPixelsPerFoot() {
            const feet = prompt('Enter the distance between the last two points in feet:', '100');
            if (feet === null) return;
            
            if (points.length < 2) {
                alert('Please mark at least 2 points first');
                return;
            }
            
            const lastPoint = points[points.length - 1];
            const secondLastPoint = points[points.length - 2];
            
            const pixelDistance = Math.sqrt(
                Math.pow(lastPoint.x - secondLastPoint.x, 2) +
                Math.pow(lastPoint.y - secondLastPoint.y, 2)
            );
            
            pixelsPerFoot = pixelDistance / parseFloat(feet);
            updateMeasurementInfo();
        }
        
        function clearMeasurement() {
            points = [];
            pixelsPerFoot = null;
            measurementMode = false;
            document.getElementById('measurementInfo').classList.remove('show');
            canvas.style.cursor = 'default';
            redrawCanvas();
        }
        
        function generateEstimate() {
            console.log('=== Generating Estimate ===');
            console.log('Current Address:', currentAddress);
            console.log('Search in progress:', searchInProgress);
            
            const roofArea = parseFloat(document.getElementById('roofArea').value);
            const laborCost = parseFloat(document.getElementById('laborCostPerSF').value);
            const shingleType = document.getElementById('shingleType').value;
            const estimatorName = document.getElementById('estimatorName').value || 'Professional Estimator';
            
            console.log('Roof area:', roofArea);
            console.log('Labor cost per SF:', laborCost);
            
            if (!roofArea || roofArea <= 0) {
                alert('Please enter a valid roof area');
                return;
            }
            
            const hasGutters = document.getElementById('gutters').checked;
            const hasDecking = document.getElementById('decking').checked;
            const hasFlashing = document.getElementById('flashing').checked;
            const hasVent = document.getElementById('ventilation').checked;
            
            // Calculate costs
            const shingleCost = roofArea * 2.50; // $2.50/SF for shingles
            const laborCostTotal = roofArea * laborCost;
            const gutterCost = hasGutters ? 200 : 0; // Linear foot estimate
            const deckingCost = hasDecking ? 500 : 0;
            const flashingCost = hasFlashing ? 800 : 0;
            const ventCost = hasVent ? 300 : 0;
            
            const baseTotal = shingleCost + laborCostTotal + gutterCost + deckingCost + flashingCost + ventCost;
            const roundedTotal = Math.round(baseTotal / 500) * 500; // Round to nearest $500
            
            // Build work items
            const workItems = [];
            workItems.push(`Remove Existing Roofing Materials Down to the wood decking ${roofArea.toFixed(0)} SF`);
            workItems.push(`Install Ice and water guards to all eyes valleys and around penetrations ${(roofArea * 0.10).toFixed(0)} SF`);
            workItems.push(`Install synthetic underlayment ${(roofArea * 0.90).toFixed(0)} SF`);
            workItems.push(`Install drip edge around roofs entire perimeter 300 LF`);
            workItems.push(`Install Shingle starter strip 300 LF`);
            workItems.push(`Install ${roofArea.toFixed(0)} SF of Atlas Pinnacle Pristine Dimensional shingles (Color of your choice)`);
            
            if (hasVent) {
                workItems.push(`Install 152 LF of Ridge vent attic ventilation`);
                workItems.push(`Install 154 LF of ridge cap shingles`);
            }
            
            if (hasFlashing) {
                workItems.push(`Install all required flashings`);
            }
            
            workItems.push(`Clean up and haul away of all job related debris`);
            
            // Display estimate
            const container = document.getElementById('estimateContainer');
            document.getElementById('workItems').innerHTML = workItems
                .map(item => `<li>${item}</li>`)
                .join('');
            
            document.getElementById('totalAmount').textContent = '$' + roundedTotal.toLocaleString();
            document.getElementById('estimateDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('propertyAddress').textContent = 'üìç Property: ' + currentAddress;
            
            // Summary
            document.getElementById('summaryArea').textContent = roofArea.toFixed(0) + ' SF';
            document.getElementById('summaryMaterial').textContent = shingleType === 'atlas' ? 'Atlas Pinnacle Pristine' : 'Premium Shingles';
            document.getElementById('summaryLabor').textContent = '$' + laborCost.toFixed(2);
            document.getElementById('summaryEstimator').textContent = estimatorName;
            
            // Notes
            const noteText = hasDecking ? 'REPLACEMENT OF WOOD DECKING IS NOT INCLUDED IN THE COST OF THIS ESTIMATE. WOOD DECKING WILL BE INSPECTED DURING THE ESTIMATE. IF ANY WOOD DECKING NEED REPLACED, THE EVIDENCE WILL BE PRESENTED TO THE PROPERTY OWNER, AND REPLACEMENT WILL FOLLOW AFTER GIVEN CONSENT FROM THE PROPERTY OWNER.\n\nDECKING REPLACEMENT COST WILL BE $70 PER 32 SQUARE FOOT SHEET OF OSB.' : 'This estimate is valid for 30 days. Prices subject to change. All work guaranteed for 5 years.';
            
            document.getElementById('notesText').innerHTML = noteText.split('\n').map(line => `<p>${line}</p>`).join('');
            
            if (hasGutters) {
                document.getElementById('additionalSection').style.display = 'block';
                const totalWithGutters = roundedTotal + 1500;
                document.getElementById('additionalText').textContent = 'Below is a price including full gutter replacement along with full roof replacement';
                document.getElementById('totalWithAddl').innerHTML = 'GUTTERS AND ROOF $' + totalWithGutters.toLocaleString();
            } else {
                document.getElementById('additionalSection').style.display = 'none';
            }
            
            container.classList.add('show');
            
            // Scroll to estimate after a brief delay
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        function exportToPDF() {
            const element = document.getElementById('estimateContainer');
            const opt = {
                margin: 10,
                filename: 'roof-estimate.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save();
        }
        
        function printEstimate() {
            const element = document.getElementById('estimateContainer');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(element.innerHTML);
            printWindow.document.close();
            printWindow.print();
        }
        
        function resetForm() {
            document.getElementById('roofArea').value = '';
            document.getElementById('laborCostPerSF').value = '4.50';
            document.getElementById('estimatorName').value = '';
            document.getElementById('roofSlope').value = '4/12';
            document.getElementById('shingleType').value = 'atlas';
            document.getElementById('gutters').checked = true;
            document.getElementById('decking').checked = true;
            document.getElementById('flashing').checked = false;
            document.getElementById('ventilation').checked = false;
        }
        
        function resetAll() {
            resetForm();
            document.getElementById('estimateContainer').classList.remove('show');
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('addressInput').value = '';
            const resultDiv = document.getElementById('addressResult');
            if (resultDiv) resultDiv.innerHTML = '';
            imageLoaded = false;
        }
    </script>
</body>
</html>
